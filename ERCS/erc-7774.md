---
eip: 7774
title: Cache invalidation in ERC-5219 mode Web3 URL
description: In ERC-5219 resolve mode, add mechanisms to alleviate limitations that prevent the use of RFC 9111 HTTP caching
author: Nicolas Deschildre (@nand2)
discussions-to: https://ethereum-magicians.org/t/erc-7774-cache-invalidation-in-erc-5219-mode-web3-url/21255
status: Draft
type: Standards Track
category: ERC
created: 2024-09-20
requires: 5219, 6944
---

## Abstract

In the context of the [ERC-6860](./eip-6860.md) `web3://` standard, this ERC extends the [ERC-6944](./eip-6944.md) resolve mode: This standard add mechanisms to alleviate limitations that prevent the use of standard [RFC 9111](https://www.rfc-editor.org/rfc/rfc9111) HTTP caching.

## Motivation

Calls to an Ethereum RPC provider are costly: CPU-wise for local nodes, and money-wise for paid external RPC providers. Additionally, external RPC providers are rate-limited, which can quickly lead to disruptions when loading `web3://` URLs.

Therefore, it makes sense to implement caching mechanisms to reduce RPC calls when possible. Since `web3://` aims to be as close to HTTP as possible, using standard [RFC 9111](https://www.rfc-editor.org/rfc/rfc9111) HTTP caching is the obvious choice. In the [ERC-6944](./eip-6944.md) resolve mode, smart contracts can already reply with standard HTTP caching headers like `Cache-Control` and `ETag`.

However, due to the [ERC-6944](./eip-6944.md) resolve mode not forwarding request HTTP headers to the smart contract, smart contracts cannot respond to the `If-None-Match` and `If-Modified-Since` cache validation headers. As a result, they are limited to the `Cache-control: max-age=XX` mechanism, meaning each cache validation request leads to an RPC call that regenerates the entire response.

This ERC defines a mechanism to bypass this limitation by allowing websites to broadcast cache invalidations using smart contract events.

Moreover, even if the smart contract could read request HTTP headers, using smart contract events is more efficient, as it shifts cache invalidation logic outside of the smart contract.

## Specification

This standard introduces the `evm-events` cache directive for the `Cache-Control` header, as an extension directive as defined in section 5.2.3 of [RFC 9111](https://www.rfc-editor.org/rfc/rfc9111).

When a [ERC-6944](./eip-6944.md) resolve mode website wants to use event-based caching for a request, it MUST : 

- Include the `evm-events` directive in the `Cache-Control` header in the response
- Include the `ETag` and/or `Cache-Control` headers in the response, as in traditional [RFC 9111](https://www.rfc-editor.org/rfc/rfc9111) HTTP caching.
- Ensure that it emits a cache invalidation event (as defined in a later section) in the smart contract when the output of the response changes and it determines that a cache clear is warranted.

The use of the `evm-events` directive is necessary to avoid a situation where a website uses traditional [RFC 9111](https://www.rfc-editor.org/rfc/rfc9111) HTTP caching headers, but does not implement this ERC  by failing to emit the events. In such cases, `web3://` clients implementing this ERC would serve stale content for that website indefinitely.


### Cache invalidation event

The event is defined as follows : 

```
event ClearPathCache(string[] paths);
```

This event can be used to clear the cache for an array of `paths`. Each `path` refers to the `pathQuery` part of the ABNF definition in [ERC-6860](./eip-6860.md). 

- A `path` MUST NOT end with a `/`, except for the root path, which is `/`. 
- For two `paths` to be considered identical, they must have the same [ERC-5219](./eip-5219.md) resource entries, and their parameter values must match, regardless of the order.

**Example**:
- `/test?a=1&b=2` and `/test?b=2&a=1` are considered identical.

#### Wildcard usage

`paths` may contain `*` wildcards with the following rules:

1. **Wildcards in Resource Entries**:
   - A wildcard (`*`) can be used on its own in an [ERC-5219](./eip-5219.md) resource entry.
   - A wildcard CANNOT be combined with other characters in the same entry; if this happens, the `path` will be ignored.
   - A wildcard requires at least one character to match.

   **Examples**:
   - `/*` will match `/test` but not `/test/abc` and not `/`.
   - `/test/*` will match `/test/abc` but will not match `/test/` or `/test/abc/def`.
   - `/*/abc` will match `/test/abc`, but not `//abc`.
   - `/t*t` is invalid, so the `path` will be ignored.

2. **Wildcards in Parameter Values**:
   - A wildcard can be used alone as a parameter value.
   - A wildcard CANNOT be combined with other characters in the parameter value, or the `path` will be ignored.
   - A wildcard in parameter values also requires at least one character to match.

   **Examples**:
   - `/abc?a=*` will match `/abc?a=zz` but not `/abc?a=` or `/abc?a=zz&b=cc`.
   - `/abc?a=*&b=*` will match `/abc?a=1&b=2` and `/abc?b=2&a=1`.
   - `/abc?a=z*` is invalid, so the `path` will be ignored.

3. **Special Case: Global Wildcard**:
   - A `path` containing only a `*` will match every path within the smart contract.

Wildcards are intentionally limited to these simple cases to facilitate efficient path lookup implementations.


### Caching behavior

#### Cache Invalidation States for `web3://` Clients

A `web3://` client can be in one of two cache invalidation states per chain and per smart contract:

1. **Listening for Events**: 
   - The `web3://` client **MUST** listen for the cache invalidation events defined earlier and should aim to remain as close to real-time as possible.
   
2. **Not Listening for Events**: 
   - This is the default state when this ERC is not implemented. In this state, the `web3://` client ignores all HTTP caching validation requests (e.g., `If-None-Match`, `If-Modified-Since` request headers).

The `web3://` client can switch between these states at any time and MAY implement heuristics to optimize the use of RPC providers by switching states when appropriate.

#### Cache Key-Value Mapping

The `web3://` client maintains a caching key-value mapping that **MUST** be cleared whenever it transitions from "Listening for Events" to "Not Listening for Events." The mapping structure is as follows:

```
mapping(
  (<chain id>, <contract address>, <ERC-6860 pathQuery>) 
  => 
  (<last modified date>, <ETag>)
)
```

Additional elements can be included in the mapping key when necessary. For example, the implementation of [ERC-7618](./eip-7618.md) requires the inclusion of the `Accept-Encoding` request header in the mapping key.

#### Handling Requests in "Listening for Events" State

When a request is received in the "Listening for Events" state:

1. **If no mapping entry exists**:
   - The `web3://` client queries the smart contract.
   - If the response includes the `evm-events` directive in the `Cache-Control` header along with an `ETag` header, a mapping entry is created using the `ETag`.
   - If the response contains the `evm-events` directive and a `max-age=XX` directive in the `Cache-Control` header, the mapping entry is created with the `last modified date`, determined by the following, in order of priority:
     - The `Last-Modified` header, if present.
     - The `Date` header, if present.
     - Otherwise, the block date when the smart contract was queried.
   - If the response includes both an `ETag` and a `Cache-Control: evm-events max-age=XX` directive, a single mapping entry is created containing both the `ETag` and the `last modified date`.

2. **If a mapping entry exists**:
   - If the request contains a valid `If-None-Match` header:
     - If the `ETag` in the mapping matches the `If-None-Match` value, the `web3://` client returns a `304 Not Modified` response immediately.
     - If the `ETag` does not match, the client queries the smart contract, deletes the mapping entry, and processes the request as if no mapping entry existed.
   
   - If the request contains a valid `If-Modified-Since` header:
     - If the `last modified date` in the mapping is earlier than the `If-Modified-Since` date, the client returns a `304 Not Modified` response immediately.
     - Otherwise, the client queries the smart contract, deletes the mapping entry, and processes the request as if no mapping entry existed.
   
   - If the request contains neither `If-None-Match` nor `If-Modified-Since` headers (or they are invalid):
     - The client queries the smart contract, deletes the mapping entry, and processes the request as if no mapping entry existed.



#### Cache Invalidation via Blockchain Events

In the "Listening for Events" state, the `web3://` client listens to the blockchain for the cache invalidation events defined in the previous section. For each path match, it deletes the corresponding mapping entry.


## Rationale

We add this feature to the [ERC-6944](./eip-6944.md) resolve mode because it can be added without changes the interface.

To stay as close as possible to standard HTTP, we reuse the HTTP caching mechanism headers.

## Security Considerations

No security considerations were found.

## Copyright

Copyright and related rights waived via [CC0](../LICENSE.md).
