---
eip: 8064
title: Management Token Permit
description: Off-chain permit flow for ERC-7204 token managers
author: Xiang (@wenzhenxiang)
discussions-to: https://ethereum-magicians.org/t/erc-8064-contract-wallet-management-token-permit-extensions/25985
status: Draft
type: Standards Track
category: ERC
created: 2025-10-28
requires: 712, 7204
---

## Abstract

This proposal extends [ERC-7204](./eip-7204.md) smart-wallet token managers with an off-chain permit flow for approvals. It introduces nonce-tracked `tokenPermit`, `tokenPermitForAll` functions, allowing individual allowances and global operator approvals to be set via typed-data signatures presented by relayers. The extension defines canonical [EIP-712](./eip-712.md) schemas, nonce accounting, and execution requirements for compliant implementations.

## Motivation

ERC-7204 defines a token management module for smart contract wallets but does not standardize an off-chain signing workflow for approvals. Applications requiring gasless approvals (e.g., delegated spending in DeFi protocols or batch operations) currently need custom encodings and nonce schemes, reducing interoperability. A standardized permit extension enables wallets, relayers, and user interfaces to handle signed approval authorizations uniformly.

Goals:

- Enable wallet owners to delegate individual allowances and operator approvals without on-chain transactions.
- Provide predictable EIP-712 schemas for uniform signing and validation across wallets and tools.
- Preserve backwards compatibility with existing ERC-7204 deployments that do not implement this extension.


## Specification

The key words "MUST", "MUST NOT", "REQUIRED", "SHALL", "SHALL NOT", "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and "OPTIONAL" in this document are to be interpreted as described in RFC 2119 and RFC 8174.

The following additions are REQUIRED for an ERC-7204 compliant module that implements this extension.

### Interface

```solidity
interface IERC8064 {
    /// @notice Returns the current nonce for individual approvals of a specific asset and spender
    function tokenApproveNonce(address asset, address spender) external view returns (uint256);

    /// @notice Returns the current nonce for operator (tokenApproveForAll) approvals
    function tokenApprovalForAllNonce(address spender) external view returns (uint256);

    /// @notice Sets approval for a specific amount via off-chain signature
    function tokenPermit(
        address asset,
        address spender,
        uint256 value,
        uint256 deadline,
        bytes calldata signature
    ) external returns (bool success);

    /// @notice Sets or revokes operator status via off-chain signature
    function tokenPermitForAll(
        address spender,
        bool approved,
        uint256 deadline,
        bytes calldata signature
    ) external returns (bool success);
}
```
- `tokenApproveNonce` MUST return a monotonically increasing nonce scoped to `(asset, spender)`.
- `tokenApprovalForAllNonce` MUST return a monotonically increasing nonce scoped to `spender`.
- `tokenPermit` MUST mirror `tokenApprove`, using a nonce scoped to `(asset, spender)`.
- `tokenPermitForAll` MUST mirror `tokenApproveForAll`, using a nonce scoped to `(spender)`.

Implementations MUST support wallets that validate signatures through [ERC-1271](./eip-1271.md). Wallets MAY wrap signatures but the module MUST unwrap them prior to verification.

### Typed Data

| Function | Primary Type | Fields |
|----------|--------------|--------|
| `tokenPermit` | `TokenPermit` | `wallet`, `asset`, `spender`, `value`, `nonce`, `deadline` |
| `tokenPermitForAll` | `TokenPermitForAll` | `wallet`, `spender`, `approved`, `nonce`, `deadline` |

Every permit MUST use the EIP-712 domain:

- `name = "TokenManager Permit"`
- `version = "1"`
- `chainId` = the executing chain
- `verifyingContract = address(this)`

### Nonce Semantics

- `tokenApproveNonce` MUST be scoped per `(asset, spender)`.
- `tokenApprovalForAllNonce` MUST be scoped per `(spender)`.

Each `permit` function MUST increment its nonce immediately before state changes and MUST revert on signature reuse.

### Execution Requirements

Implementations MUST:

1. Treat `deadline == 0` as non-expiring; otherwise require `block.timestamp <= deadline`.
2. Recover the signer from the signature using EIP-712 digest. If the recovered address is a contract, validate the digest using ERC-1271 on the wallet address. The recovered/validated signer MUST equal the wallet owner.
3. Verify the provided nonce matches the current stored nonce for the corresponding scope.
4. Increment the scoped nonce before invoking the underlying ERC-7204 approval function.
5. Emit the same events as the corresponding ERC-7204 functions.
6. Revert on any validation failure or if the downstream approval call reverts.


## Rationale

- Naming functions `tokenPermit` and `tokenPermitForAll` aligns with the widely adopted [ERC-2612](./eip-2612.md) pattern while distinguishing the two operations.
- Scoped nonces provide strong replay protection and allow independent management of different assets and operators.
- Including the `wallet` owner in the signed message prevents cross-wallet replay attacks.
- Internally delegating to existing ERC-7204 approval functions ensures full compatibility with events, storage, and existing tooling.

## Backwards Compatibility

Existing ERC-7204 modules remain valid. Clients SHOULD feature-detect permit support by checking for `IERC8064` via [ERC-165](./eip-165.md) or probing the new function selectors.

## Test Cases

A public test suite will accompany the reference implementation. Implementers are encouraged to cover:

- successful submissions for allowances, and spender approvals,
- rejection of expired, replayed, or mismatched signatures,
- nonce increment behaviour when token interactions revert,
- replay protection across all nonce scopes.

## Reference Implementation

A reference implementation will be published after community review. It validates the typed-data digest, increments the scoped nonce before external calls, and delegates to existing ERC-7204 functions so that storage and events remain unchanged.

## Security Considerations

- Nonces MUST increment even if downstream token interactions revert.
- Wallet owners SHOULD bound permit deadlines to reduce the risk of long-lived signatures.

## Copyright

Copyright and related rights waived via [CC0](../LICENSE.md).
